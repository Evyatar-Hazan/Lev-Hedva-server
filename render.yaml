# ===================================
# קובץ הגדרות Render - Lev Hedva Backend
# ===================================
# קובץ זה מגדיר את כל השירותים הנדרשים לפריסה אוטומטית ב-Render
# כולל: Web Service, PostgreSQL Database, ו-Environment Variables

databases:
  # ===================================
  # PostgreSQL Database
  # ===================================
  - name: levhedva-db
    databaseName: levhedva
    user: levhedva
    plan: free # או starter/standard לפי הצורך
    ipAllowList: [] # ריק = מאפשר גישה מכל מקום (נדרש ל-Render services)

services:

services:
  # ===================================
  # Backend Web Service (NestJS)
  # ===================================
  - type: web
    name: levhedva-backend
    env: node
    plan: free # או starter/standard לפי הצורך
    region: frankfurt # או oregon, singapore לפי המיקום שלך
    repo: https://github.com/Evyatar-Hazan/Lev-Hedva-server
    branch: main
    buildCommand: |
      # התקנת dependencies
      npm install
      # הרצת Prisma
      npx prisma generate
      # בניית הפרויקט
      npm run build
    startCommand: |
      # Check and resolve any failed migrations
      bash scripts/pre-migrate.sh
      # הרצת כל ה-migrations שטרם רצו (כולל data migrations)
      npx prisma migrate deploy
      # הפעלת השרת
      npm run start:prod
    healthCheckPath: /api/health

    # ===================================
    # Environment Variables
    # ===================================
    envVars:
      # Node Environment
      - key: NODE_ENV
        value: production

      # Port - Render מגדיר אוטומטית
      - key: PORT
        value: 10000

      # Database URL - מתחבר אוטומטית ל-Database שהגדרנו למעלה
      # Render ימלא את זה אוטומטית מה-Internal Database URL
      - key: DATABASE_URL
        fromDatabase:
          name: levhedva-db
          property: connectionString

      # JWT Secret - **חשוב! שנה את זה לערך חזק**
      # צור סיסמה חזקה עם: node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
      - key: JWT_SECRET
        generateValue: true # Render יצור ערך אקראי חזק

      - key: JWT_EXPIRES_IN
        value: 24h

      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d

      # CORS - **חשוב! שנה את זה לכתובת ה-Netlify שלך**
      # לדוגמה: https://levhedva.netlify.app
      - key: CORS_ORIGIN
        value: https://your-app.netlify.app

      # Admin User (לשימוש ב-seed)
      - key: ADMIN_EMAIL
        value: admin@levhedva.org

      - key: ADMIN_PASSWORD
        value: Admin123!

      - key: ADMIN_NAME
        value: מנהל מערכת

    # ===================================
    # Auto Deploy
    # ===================================
    # Deploy אוטומטי מ-GitHub
    autoDeploy: true

    # ===================================
    # Branch
    # ===================================
    # הבראנץ' שממנו לעשות deploy
    branch: main

    # ===================================
    # Root Directory
    # ===================================
    # אם הקוד נמצא בתיקייה משנה (במקרה שלנו Lev-Hedva-sever)
    # rootDir: ./Lev-Hedva-sever

# ===================================
# הערות חשובות:
# ===================================
# 1. לאחר יצירת השירות ב-Render:
#    - עבור ל-Dashboard
#    - בחר את ה-Service
#    - לחץ על Environment
#    - ודא שכל המשתנים מוגדרים נכון
#    - **שנה את CORS_ORIGIN לכתובת ה-Netlify שלך**
#    - **שנה את JWT_SECRET לערך חזק**
#
# 2. Database:
#    - ה-DATABASE_URL יתווסף אוטומטית
#    - אפשר לראות אותו ב-Environment Variables
#    - אל תשנה אותו ידנית
#
# 3. Migrations:
#    - הן ירוצו אוטומטית בכל deploy
#    - אם יש שגיאה, בדוק את ה-logs
#
# 4. Seed:
#    - כרגע מוערם (commented out)
#    - הסר הערה אם רוצה להריץ בכל deploy
#    - או הרץ ידנית דרך Shell:
#      npx prisma db seed
#
# 5. Health Check:
#    - Render יבדוק את /api/health
#    - ודא שה-endpoint הזה קיים בקוד
#
# 6. Free Tier Limitations:
#    - השרת "יירדם" אחרי 15 דקות של חוסר פעילות
#    - הבקשה הראשונה תיקח ~30 שניות
#    - שדרג ל-Starter Plan ($7/mo) למניעת שינה
#
# 7. Logs:
#    - ניתן לראות logs ב-Render Dashboard
#    - שימושי לדיבאג בעיות
#
# 8. Custom Domain (אופציונלי):
#    - אפשר להוסיף דומיין משלך ב-Settings
